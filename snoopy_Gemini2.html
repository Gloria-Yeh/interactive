<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snoopy & Woodstock Voxel Garden</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #87CEEB; }
        canvas { display: block; }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-family: sans-serif; font-size: 24px; font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="loading">正在构建体素花园...</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 配置参数 ---
        const VOXEL_SIZE = 1;
        const GAP = 0.05; // 体素之间的微小缝隙，增加艺术感
        
        // --- 颜色调色板 ---
        const PALETTE = {
            SNOOPY_WHITE: 0xFFFFFF,
            SNOOPY_BLACK: 0x111111,
            COLLAR_RED: 0xD32F2F,
            WOODSTOCK_YELLOW: 0xFFEB3B,
            GRASS_GREEN: 0x66BB6A,
            GRASS_DARK: 0x4CAF50,
            DOGHOUSE_RED: 0xE53935,
            FLOWER_PETAL: [0xFF4081, 0x7C4DFF, 0xFFAB40], // 随机花朵颜色
            FLOWER_CENTER: 0xFFFFFF
        };

        // --- 初始化场景 ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // 天空蓝
        scene.fog = new THREE.Fog(0x87CEEB, 20, 80);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(-15, 15, 25); // 相机初始位置

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true; // 开启阴影
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.target.set(0, 2, 0);

        // --- 灯光设置 ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.9);
        dirLight.position.set(-20, 30, 10);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048;
        dirLight.shadow.mapSize.height = 2048;
        dirLight.shadow.camera.near = 0.5;
        dirLight.shadow.camera.far = 100;
        dirLight.shadow.camera.left = -30;
        dirLight.shadow.camera.right = 30;
        dirLight.shadow.camera.top = 30;
        dirLight.shadow.camera.bottom = -30;
        scene.add(dirLight);

        // --- 辅助函数：体素构建器 ---
        const boxGeometry = new THREE.BoxGeometry(VOXEL_SIZE - GAP, VOXEL_SIZE - GAP, VOXEL_SIZE - GAP);
        
        // 缓存材质以提高性能
        const materials = {};
        function getMaterial(color) {
            if (!materials[color]) {
                materials[color] = new THREE.MeshStandardMaterial({ 
                    color: color, 
                    roughness: 0.8,
                    flatShading: false 
                });
            }
            return materials[color];
        }

        // 创建单个体素并添加到父对象
        function addVoxel(parent, x, y, z, colorHex) {
            const mesh = new THREE.Mesh(boxGeometry, getMaterial(colorHex));
            mesh.position.set(x * VOXEL_SIZE, y * VOXEL_SIZE, z * VOXEL_SIZE);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            parent.add(mesh);
            return mesh;
        }

        // --- 角色构建：史努比 ---
        function createSnoopy() {
            const group = new THREE.Group();

            // 身体 (坐姿)
            // 躯干
            for(let y=0; y<4; y++) {
                for(let x=0; x<3; x++) {
                    for(let z=0; z<3; z++) {
                         // 简单的圆角处理：去掉四个角的柱子
                        if((x===0 || x===2) && (z===0 || z===2)) continue;
                        addVoxel(group, x, y, z, PALETTE.SNOOPY_WHITE);
                    }
                }
            }
            
            // 腿 (向前伸出)
            addVoxel(group, 1, 0, 3, PALETTE.SNOOPY_WHITE);
            addVoxel(group, 1, 0, 4, PALETTE.SNOOPY_WHITE);
            // 脚掌
            addVoxel(group, 1, 1, 4, PALETTE.SNOOPY_WHITE); 
            addVoxel(group, 0, 0, 3, PALETTE.SNOOPY_WHITE); // 左脚
            addVoxel(group, 2, 0, 3, PALETTE.SNOOPY_WHITE); // 右脚

            // 项圈
            for(let x=0; x<3; x++) {
                for(let z=0; z<3; z++) {
                    if((x===0 || x===2) && (z===0 || z===2)) continue;
                    addVoxel(group, x, 3.8, z, PALETTE.COLLAR_RED);
                }
            }

            // 头部组 (为了动画需要单独分组)
            const headGroup = new THREE.Group();
            headGroup.position.set(1, 4, 1); // 设置旋转中心点
            
            // 头部主体
            for(let y=0; y<4; y++) {
                for(let x=-2; x<=2; x++) {
                    for(let z=-2; z<=3; z++) { // z延伸作为鼻子基础
                        // 简单的球形近似剔除
                        if (Math.abs(x)===2 && Math.abs(z)>=2) continue;
                        if (y===3 && (Math.abs(x)===2 || Math.abs(z)>=2)) continue; 
                        
                        addVoxel(headGroup, x, y, z, PALETTE.SNOOPY_WHITE);
                    }
                }
            }

            // 鼻子 (黑色圆点)
            addVoxel(headGroup, 0, 1, 3.2, PALETTE.SNOOPY_BLACK);

            // 耳朵 (黑色，下垂)
            // 左耳
            for(let y=-1; y<3; y++) addVoxel(headGroup, -2.2, y, 0, PALETTE.SNOOPY_BLACK);
            addVoxel(headGroup, -2.2, -1, 1, PALETTE.SNOOPY_BLACK);
            // 右耳
            for(let y=-1; y<3; y++) addVoxel(headGroup, 2.2, y, 0, PALETTE.SNOOPY_BLACK);
            addVoxel(headGroup, 2.2, -1, 1, PALETTE.SNOOPY_BLACK);

            // 眼睛
            addVoxel(headGroup, -1, 2, 2.8, PALETTE.SNOOPY_BLACK); // 左眼
            addVoxel(headGroup, 1, 2, 2.8, PALETTE.SNOOPY_BLACK);  // 右眼

            group.add(headGroup);
            group.userData.head = headGroup; // 引用以便动画使用

            return group;
        }

        // --- 角色构建：糊涂塌客 ---
        function createWoodstock() {
            const group = new THREE.Group();
            
            // 身体
            addVoxel(group, 0, 0, 0, PALETTE.WOODSTOCK_YELLOW);
            addVoxel(group, 0, 1, 0, PALETTE.WOODSTOCK_YELLOW);
            addVoxel(group, -1, 0.5, 0, PALETTE.WOODSTOCK_YELLOW); // 尾巴/后部
            
            // 头部
            addVoxel(group, 0, 2, 0, PALETTE.WOODSTOCK_YELLOW);
            addVoxel(group, 0, 2.5, -0.5, PALETTE.WOODSTOCK_YELLOW); // 冠毛
            addVoxel(group, 0, 3, 0, PALETTE.WOODSTOCK_YELLOW); // 冠毛顶

            // 嘴巴 (长长的)
            addVoxel(group, 0, 1.8, 1, PALETTE.WOODSTOCK_YELLOW); 
            addVoxel(group, 0, 1.8, 1.5, PALETTE.WOODSTOCK_YELLOW);

            // 眼睛
            const eye = new THREE.Mesh(
                new THREE.BoxGeometry(0.2, 0.2, 0.1),
                new THREE.MeshStandardMaterial({color: 0x000000})
            );
            eye.position.set(0.3, 2.2, 0.5);
            group.add(eye);

            return group;
        }

        // --- 环境构建：花园和狗屋 ---
        function createGarden() {
            const gardenGroup = new THREE.Group();

            // 地面 (使用 InstancedMesh 优化性能)
            const groundSize = 30;
            const geometry = new THREE.BoxGeometry(VOXEL_SIZE, VOXEL_SIZE, VOXEL_SIZE);
            const material = getMaterial(PALETTE.GRASS_GREEN);
            const groundMesh = new THREE.InstancedMesh(geometry, material, groundSize * groundSize);
            
            const dummy = new THREE.Object3D();
            let index = 0;
            for(let x = -groundSize/2; x < groundSize/2; x++) {
                for(let z = -groundSize/2; z < groundSize/2; z++) {
                    dummy.position.set(x * VOXEL_SIZE, -1, z * VOXEL_SIZE);
                    // 随机高度变化，增加自然感
                    const heightVar = Math.random() > 0.8 ? 0.2 : 0;
                    dummy.position.y = -1 + heightVar;
                    
                    // 棋盘格纹理变化
                    if ((Math.abs(x) + Math.abs(z)) % 2 === 0) {
                        dummy.scale.set(1, 1, 1);
                    } else {
                        dummy.scale.set(1, 0.9, 1); // 稍微低一点
                    }
                    
                    dummy.updateMatrix();
                    groundMesh.setMatrixAt(index++, dummy.matrix);
                    
                    // 随机颜色变化 (这里需要更复杂的逻辑支持InstancedMesh颜色，为简化暂略，统一绿色)
                }
            }
            gardenGroup.add(groundMesh);

            // 标志性狗屋
            const houseGroup = new THREE.Group();
            houseGroup.position.set(-8, 0, -8);
            houseGroup.rotation.y = Math.PI / 4;
            
            // 墙体
            for(let x=0; x<6; x++) {
                for(let y=0; y<5; y++) {
                    for(let z=0; z<8; z++) {
                        if (x>0 && x<5 && y<3 && z>0 && z<7) continue; // 空心
                        addVoxel(houseGroup, x, y, z, PALETTE.DOGHOUSE_RED);
                    }
                }
            }
            // 屋顶
            for(let i=0; i<5; i++) {
                // 简单的金字塔层级
                const width = 8 - (i*2);
                if (width < 1) break;
                for(let z=-1; z<9; z++) { // 屋顶伸出一点
                   addVoxel(houseGroup, -1 + i, 5+i, z, PALETTE.DOGHOUSE_RED);
                   addVoxel(houseGroup, 6 - i, 5+i, z, PALETTE.DOGHOUSE_RED);
                   // 填充中间
                   for(let k = -1+i; k<=6-i; k++) {
                       addVoxel(houseGroup, k, 5+i, z, PALETTE.DOGHOUSE_RED);
                   }
                }
            }
            gardenGroup.add(houseGroup);

            // 随机的花朵
            for(let i=0; i<15; i++) {
                const flowerGroup = new THREE.Group();
                const x = (Math.random() - 0.5) * 20;
                const z = (Math.random() - 0.5) * 20;
                // 避开中心区域
                if(Math.abs(x) < 5 && Math.abs(z) < 5) continue;

                flowerGroup.position.set(x, 0, z);
                
                // 茎
                addVoxel(flowerGroup, 0, 0, 0, PALETTE.GRASS_DARK);
                addVoxel(flowerGroup, 0, 1, 0, PALETTE.GRASS_DARK);
                
                // 花瓣
                const color = PALETTE.FLOWER_PETAL[Math.floor(Math.random() * PALETTE.FLOWER_PETAL.length)];
                addVoxel(flowerGroup, 1, 2, 0, color);
                addVoxel(flowerGroup, -1, 2, 0, color);
                addVoxel(flowerGroup, 0, 2, 1, color);
                addVoxel(flowerGroup, 0, 2, -1, color);
                addVoxel(flowerGroup, 0, 2, 0, PALETTE.FLOWER_CENTER); // 花心

                gardenGroup.add(flowerGroup);
            }

            return gardenGroup;
        }

        // --- 组装场景 ---
        
        // 1. 添加花园
        scene.add(createGarden());

        // 2. 添加史努比
        const snoopy = createSnoopy();
        snoopy.position.set(-4, 0, 0); 
        snoopy.rotation.y = Math.PI / 2; // 面向右侧
        scene.add(snoopy);

        // 3. 添加糊涂塌客
        const woodstock = createWoodstock();
        woodstock.position.set(4, 2, 0); // 在空中
        woodstock.rotation.y = -Math.PI / 2; // 面向左侧 (面对史努比)
        scene.add(woodstock);

        document.getElementById('loading').style.display = 'none';

        // --- 动画循环 ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);

            const time = clock.getElapsedTime();

            // 动画 1: 糊涂塌客悬浮飞行
            woodstock.position.y = 2 + Math.sin(time * 5) * 0.3;
            woodstock.rotation.z = Math.sin(time * 10) * 0.05; // 飞行时的微微摇摆

            // 动画 2: 史努比头部晃动 (仿佛在聊天)
            if (snoopy.userData.head) {
                snoopy.userData.head.rotation.z = Math.sin(time * 2) * 0.1;
                snoopy.userData.head.rotation.y = Math.sin(time * 1.5) * 0.1;
            }

            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        // --- 窗口调整 ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>